
<!DOCTYPE html>
<html lang="en" manifest="/manifest.appcache">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>We have a problem with promises</title>
    <link rel="alternate" title="PouchDB, the JavaScript Database that Syncs!" type="application/rss+xml" href="/feed.xml">
    <link rel="stylesheet" href="static/css/pouchdb.css" />
    <meta name="theme-color" content="#6ccb99">
    <meta name="msapplication-TileColor" content="#6ccb99">
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-42479701-1']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <link href='//fonts.googleapis.com/css?family=Lato:400,700|Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="icon" href="static/favicon.ico" type="image/x-icon"/>
</head>

<body data-spy="scroll" data-target="#sidebar">

<header role="banner">

    <a href="https://http://nextzeus.github.io/unknownJS/aboutThis" target="_blank">
        <div class="ribbon">GitHub</div>
    </a>

    <div class="container">

        <a class="logo" href="/">
            <div class="logo-img"></div>
            <span class='logo-type'>PouchDB</span>
        </a>

        <ul class='nav nav-header nav-pills' role="navigation">
            <li>
                <a class='btn btn-link btn-lg' href="/blog/">Blog</a>
            </li>
            <li>
                <a class='btn btn-link btn-lg' href="/guides/">Guides</a>
            </li>
            <li>
                <a class='btn btn-link btn-lg' href="/api.html">API</a>
            </li>
            <li>
                <a class='btn btn-link btn-lg' href="/learn.html">Learn</a>
            </li>
            <li>
                <a class='btn btn-primary btn-lg' href="/download.html">Download <strong>v5.3.2</strong></a>
            </li>
        </ul>

    </div>

</header>

<div class="page-head">

    <div class="container">

        <h1 class="page-title">We have a problem with promises</h1>
          
            <span class="h1">
                <a
                    data-toggle="tooltip"
                    data-placement="top"
                    title="Edit this on Github"
                    class="icon-edit"
                    href="https://github.com/pouchdb/pouchdb/edit/master/docs/_posts/2015-05-18-we-have-a-problem-with-promises.md"
                    target="_blank">

                </a>

            </span>

    </div>

</div>


<div role="main">
    <article class='container'>
        <div class='row'>
            <article class='col-md-offset-1 col-md-10' role="article">

                <div class="post">
                    <div class="media">
                        <a class="pull-left" href="#">
                            <img class="media-object img-circle img-responsive" src='http://nextzeus.github.io/images/head.jpeg' alt='Xiaodong Li'>
                        </a>
                        <div class="media-body">
                            <p>
                                <strong>By:</strong> <a href="http://nextzeus.github.io">Xiaodong Li</a><br>
                                <strong>Published:</strong> 27 May 2016<br>

                            </p>
                        </div>
                    </div>
                </div>


                <p>Fellow JavaScripters, it&#39;s time to admit it: we have a problem with promises.</p>

                <p>No, not with promises themselves. Promises, as defined by the <a href="https://promisesaplus.com/">A+ spec</a>, are awesome.</p>

                <p>The big problem, which has revealed itself to me over the course of the past year, as I&#39;ve watched numerous programmers struggle with the PouchDB API and other promise-heavy APIs, is this:</p>

                <p>Many of us are using promises <em>without really understanding them</em>.</p>

                <p>If you find that hard to believe, consider this puzzle <a href="https://twitter.com/nolanlawson/status/578948854411878400">I recently posted to Twitter</a>:</p>

                <p><strong>Q: What is the difference between these four promises?</strong></p>
                <div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">doSomething</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">doSomethingElse</span><span class="p">();</span>
                    <span class="p">});</span>

                    <span class="nx">doSomething</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="nx">doSomethingElse</span><span class="p">();</span>
                    <span class="p">});</span>

                    <span class="nx">doSomething</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">doSomethingElse</span><span class="p">());</span>

                    <span class="nx">doSomething</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">doSomethingElse</span><span class="p">);</span>
                </code></pre></div>

                <p>Looking at how people use PouchDB, which has a largely promise-based API, I see a lot of poor promise patterns. The most common bad practice is this one:</p>
                <div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">remotedb</span><span class="p">.</span><span class="nx">allDocs</span><span class="p">({</span>
                    <span class="nx">include_docs</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                    <span class="nx">attachments</span><span class="o">:</span> <span class="kc">true</span>
                    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">docs</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">;</span>
                    <span class="nx">docs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">localdb</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">doc</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Pulled doc with id &quot;</span> <span class="o">+</span> <span class="nx">element</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span> <span class="o">+</span> <span class="s2">&quot; and added to local db.&quot;</span><span class="p">);</span>
                    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">409</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">localdb</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">localdb</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">_rev</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// et cetera...</span>
                </code></pre></div>
                <p>Yes, it turns out you can use promises as if they were callbacks, and yes, it&#39;s a lot like using a power sander to file your nails, but you can do it.</p>

                <p>And if you think this sort of mistake is only limited to absolute beginners, you&#39;ll be surprised to learn that I actually took <a href="https://github.com/blackberry/BB10-WebWorks-Community-Samples/blob/d6ee75fe23a10d2d3a036013b6b1a0c07a542099/pdbtest/www/js/index.js">the above code</a> from <a href="http://devblog.blackberry.com/2015/05/connecting-to-couchbase-with-pouchdb/">the official BlackBerry developer blog</a>! Old callback habits die hard. (And to the developer: sorry to pick on you, but your example is instructive.)</p>

                <p>A better style is this one:</p>
                <div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">remotedb</span><span class="p">.</span><span class="nx">allDocs</span><span class="p">(...).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resultOfAllDocs</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">localdb</span><span class="p">.</span><span class="nx">put</span><span class="p">(...);</span>
                    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resultOfPut</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">localdb</span><span class="p">.</span><span class="nx">get</span><span class="p">(...);</span>
                    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resultOfGet</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">localdb</span><span class="p">.</span><span class="nx">put</span><span class="p">(...);</span>
                    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                    <span class="p">});</span>
                </code></pre></div>
                <p>This is called <em>composing promises</em>, and it&#39;s one of the great superpowers of promises. Each function will only be called when the previous promise has resolved, and it&#39;ll be called with that promise&#39;s output. More on that later.</p>

                <h2>Rookie mistake #2: WTF, how do I use <code>forEach()</code> with promises?</h2>

                <div class="alert alert-info">


                    <div class="alert-text">


                        <p>For more about why this is an anti-pattern, check out <a href="https://github.com/petkaantonov/bluebird/wiki/Promise-anti-patterns#the-deferred-anti-pattern">the Bluebird wiki page on promise anti-patterns</a>.</p>

                    </div></div>

            </article>
        </div>
    </article>

</div>

<div class="icons">

    <div class="container">

        <div class="row">

            <div class='col-xs-4 col-md-offset-0 col-md-2'>
                <a href='https://twitter.com/pouchdb' target='_blank'>
                    <div class="icon icon-twitter"></div>
                    <span class="sr-only">PouchDB's Twitter</span>
                </a>
            </div>

            <div class='col-xs-4 col-md-2'>
                <a href='https://github.com/rvagg/node-levelup' target='_blank'>
                    <div class="icon icon-leveldb"></div>
                    <span class="sr-only">Node Levelup</span>
                </a>
            </div>

            <div class='col-xs-4 col-md-2'>
                <a href='https://github.com/pouchdb/pouchdb' target='_blank'>
                    <div class="icon icon-github"></div>
                    <span class="sr-only">PouchDB's Github Repo</span>
                </a>
            </div>

            <div class='col-xs-4 col-md-offset-0 col-md-2'>
                <a href='https://travis-ci.org/pouchdb/pouchdb' target='_blank'>
                    <div class="icon icon-travis"></div>
                    <span class="sr-only">PouchDB's Travis CI</span>
                </a>
            </div>

            <div class='col-xs-4 col-md-2'>
                <a href='http://couchdb.apache.org/' target='_blank'>
                    <div class="icon icon-couchdb"></div>
                    <span class="sr-only">CouchDB</span>
                </a>
            </div>

            <div class='col-xs-4 col-md-2'>
                <a href='https://saucelabs.com' target='_blank'>
                    <div class="icon icon-saucelabs"></div>
                    <span class="sr-only">Saucelabs</span>
                </a>
            </div>

        </div>

    </div>

</div>

<footer class="footer">

    <div class="container">

        <div class="row">

            <div class='col-sm-3'>
                <h3 class="nav-head">Learn</h3>
                <ul class='nav nav-silent'>
                    <li><a href="/getting-started.html">Getting Started</a></li>
                    <li><a href="/api.html">API Guide</a></li>
                    <li><a href="https://github.com/pouchdb/pouchdb/wiki">Wiki</a></li>
                </ul>
            </div>

            <div class='col-sm-3'>
                <h3 class="nav-head">Discuss</h3>
                <ul class='nav nav-silent'>
                    <li><a href="https://groups.google.com/forum/#!forum/pouchdb">Mailing List</a></li>
                    <li><a href="irc://freenode.net/#pouchdb">IRC</a></li>
                    <li><a href="http://slack.pouchdb.com/">Slack</a></li>
                    <li><a href="http://twitter.com/pouchdb">Twitter</a></li>
                    <li><a href="http://stackoverflow.com/questions/tagged/pouchdb">StackOverflow</a></li>
                </ul>
            </div>

            <div class='col-sm-3'>
                <h3 class="nav-head">Contribute</h3>
                <ul class='nav nav-silent'>
                    <li><a href="https://github.com/pouchdb/pouchdb/blob/master/CONTRIBUTING.md">Contributing</a></li>
                    <li><a href="https://github.com/pouchdb/pouchdb">Source</a></li>
                    <li><a href="https://github.com/pouchdb/pouchdb/issues">Issues</a></li>
                    <li><a href="https://github.com/pouchdb/pouchdb/blob/master/LICENSE">Apache License</a></li>
                </ul>
            </div>

        </div>

    </div>

</footer>
<script type="text/javascript" src="//code.jquery.com/jquery.min.js"></script>
<script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="static/js/code.min.js"></script>
<script type="text/javascript" src="static/js/stickyfill.min.js"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/pouchdb/latest/pouchdb.min.js"></script>
<script type="text/javascript">
    var $navSidebarWrapper = $('.nav-sidebar-wrapper');
    if ($navSidebarWrapper.length) {
        $navSidebarWrapper.Stickyfill();
    }
    $('[data-toggle="tooltip"]').tooltip();
    function onCached(e) {
        if (applicationCache.status === 1) {
            giveIntro();
        }
    }

    function giveIntro() {
        console.log('%c\n..............................................................................\n.?I...........~+: ............................................................\n.???.........++++.............................................................\n:????+......+++++.............................................................\n.??????+++++++++:.................................H...........D..B............\n...????++++++++...................................H...........D..B............\n...=????++++++.......PPPPP...OOOO...U....U...CCCC.HHHHH...DDDDD..BBBBB........\n...?????+++++++......P...:P.OO...O..U....U..C.....H...H..D....D..B....B.......\n..???????+++++++ ....P. ..P.O....O..U....U.CC.....H...H..D....D..B....B.......\n..?????????????......P...:P.OO...O..U....U..C.....H...H..D....D..B....B.......\n...I??????????~......PPPPP...OOOO...=UUUUU...CCCC.H...H...DDDDD..BBBBB........\n....?????????~.......P.... ...................................................\n.....???????+........P........................................................\n......??????..................................................................\n..............................................................................\n..............................................................................\n..............................................................................', 'color: #4ec084');
        console.log('%c\nPouchDB itself is hosted at PouchDB.com!\nTo get started, try typing:\nvar db = new PouchDB(\'mydb\');', 'color: #4ec084');
    }
    function offerToReload() {
        $('.js-update-notification')
                .removeClass('btn-update-hidden')
                .on('click', function(){
                    window.location.reload();
                });
    }
    if (window.applicationCache) {
        applicationCache.addEventListener('cached', onCached, false);
        applicationCache.addEventListener('noupdate', giveIntro, false);
        applicationCache.addEventListener('updateready', offerToReload, false);
    }
</script>
<button type="button" class="js-update-notification btn btn-primary btn-update btn-update-hidden">
    Content updated, reload now? â†»
</button>
</body>
</html>
